<!DOCTYPE html>
<HTML LANG="en">
  <HEAD>
    <META CHARSET="utf-8"/>
    <META NAME="viewport" CONTENT="width=device-width, initial-scale=1.0">
    <TITLE>safe_api example</TITLE>
    <SCRIPT src="dist/safe_api.js"></SCRIPT>
  </HEAD>
  <BODY>
    <NOSCRIPT><P>Unfortunately JavaScript is required for this player. Your is disabled! You must now determine whether playing music through this app or enabling JavaScript is more important to you.</P></NOSCRIPT>
    <DIV>
      <P>List output</P>
      <UL id="file_list"></UL>
    </DIV>

    <SCRIPT>
      var file_list = document.getElementById('file_list');
      function populate_file_list(file) {
        var item = document.createElement("LI");
        item.textContent = file;
        file_list.appendChild(item);
      }

      var make_datastore = function (app, my_md) {
        // if no datastore, generate datastore:
        let store_md = app.quickRandomPublic({});
        let directory = store_md.asNFS();

        // example file for datastore
        let file = directory.create('this is the data!');
        file.getHandle();
        directory.insert('first.txt');
        file.free();

        // save datastore
        store_md.saveToMdAs(my_md, 'datastore');

        directory.free();
        store_md.free();
      }

      var main_func = function () {
	let app_info = {
          'id': 'com.bbonvallet.maidsafe.safe_api.example',
          'name': 'SAFE API Example',
          'version': '0.0.1',
          'vendor': 'Bryan Bonvallet Consulting, LLC'
	}

	let app = safeAPI.initialiseApp(app_info);
	app.setDebug(75);
	app.authoriseAndConnect({_public: ['Read']}, {'own_container': true});

	app.log('Beginning MD test.');
	let md = app.quickRandomPublic({'this': 'is', 'a': 'test'});
	md.getString('this').log('should be "is":').log();
	md.getString('a').log('should be "test":').log();
	md.free();
	app.log('Initial MD test done!');

	app.log('Beginning ID test.');
	let id_writer = app.newImmutableData();
	id_writer.write('test of the immutable data contents!');
	let cipher = app.newPublicCipher();
	cipher.getHandle();
	id_writer.closeWriter();
	cipher.free();

	id_writer.getXorName();
	let id_reader = app.loadImmutableData();
	id_reader.readString().log('ImmutableData contents:').log();
	id_reader.free();
	app.log('Initial ID test done!');

	app.log('getting Own container MD');
	let my_md = app.getOwnContainer();
	my_md.catch((err) => {
	  if (err.toString().indexOf('Container not found') >= 0) {
	    // Container was not found. Indicate how to fix.
	    my_md._debug(0, 'Error: Please set own_container to true in authoriseAndConnect() options.');
	  }
	  // Continue the error flowing.
	  throw err;
	});
	my_md.getVersion().log('own container version:').log();

	my_md.get('datastore');
	my_md.datastore_exists = true;
	my_md.catch((err) => {
	  if (err.toString().indexOf('Requested entry not found') >= 0) {
	    my_md._debug(75, 'Library is missing. Create it!');
	    my_md.datastore_exists = false;
	  } else {
	    throw err;
	  }
	});
	my_md.skipToLabelIf('DATASTORE_MADE', 'datastore_exists');

	my_md.log('making datastore');
	make_datastore(app, my_md);

	app.markLabel('DATASTORE_MADE');

	store_md = my_md.loadMdFrom('datastore');

	// list files in datastore
	ent = store_md.getEntries();
	ent.forEach(populate_file_list);
	ent.free();

	store_md.free()

	app.resetDebug();
	app.log('App completed.');
	app.catch((err) => console.log(err));
	app.free();
      }
      if (window.safeApp === undefined) {
        main_func = function () {
          console.log('Missing window.safeApp!');
        };
      }

      main_func();
    </SCRIPT>

  </BODY>
</HTML>
